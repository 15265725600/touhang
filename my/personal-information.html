<!DOCTYPE html>
<html>

  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="description" content="">
    <meta name="keywords" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <title>投行365</title>
    <link rel="stylesheet" href="../assets/css/amazeui.min.css">
    <link rel="stylesheet" href="../assets/css/style.css">
  </head>

  <body>
    <header data-am-widget="header" class="am-header header">
      <a href="javascript:history.back()" class="arrow-left"></a>
      <h1 class="am-header-title">基本信息</h1>
    </header>
    <div class="reg-container">
      <ul class="reg-wrapper" id="my_infor">
        <script type="text/html" id="template">
          <li class="list-item am-cf">
            <span class="name first">头像</span>
            <div class="avatar am-fr">
              <img src="{{infor[0].avatar}}" alt="" class="img" width="50" height="50" />
              <input type="file" class="upload_img" accept="image/*" name="temp_file" />
            </div>
            <i class="arrow-right"></i>
          </li>
          <li class="list-item">
            <a href="">
              <span class="name">姓名</span>
              <input type="text" class="txt" placeholder="填写姓名" id="name" value="{{infor[0].username}}" />
            </a>
            <i class="arrow-right"></i>
          </li>
          <li class="list-item">
            <a href="javascript:;" data-am-offcanvas="{target: '#doc-oc-demo1'}">
              <span class="name">业务专长</span>
              <input type="text" class="txt am-ellipsis" placeholder="填写专长" value="{{infor[0].be_good}}" readonly="readonly" id="expertise" maxlength="300"/>
            </a>
            <i class="arrow-right"></i>
          </li>
          <li class="list-item">
            <a href="javascript:;" data-am-offcanvas="{target: '#doc-oc-demo2'}">
              <span class="name">公司简称</span>
              <input type="text" class="txt" placeholder="最多25个字" value="{{infor[0].company}}" maxlength="25" readonly="readonly" id="company_name" />
            </a>
            <i class="arrow-right"></i>
          </li>
          <!--<li class="list-item" id="addr">
            <span class="name">地区</span>
            <input type="text" class="txt" placeholder="选择地区" readonly="readonly" id="address" value="{{infor[0].district}}"/>
            <i class="arrow-right"></i>
          </li>-->
          <li class="list-item">
            <a href="javascript:;" data-am-offcanvas="{target: '#doc-oc-demo3'}">
              <span class="name">职务/职称</span>
              <input type="text" class="txt" placeholder="填写职务" readonly="readonly" id="work" value="{{infor[0].job}}" />
            </a>
            <i class="arrow-right"></i>
          </li>
          <!--<li class="list-item">
            <a href="javascript:;" data-am-offcanvas="{target: '#doc-oc-demo4'}">
              <span class="name">微信号</span>
              <input type="text" class="txt" placeholder="填写微信号" readonly="readonly" id="wx_name" value="{{infor[0].wx_name}}" />
            </a>
            <i class="arrow-right"></i>
          </li>-->
        </script>
      </ul>
      <div class="submit line" id="submit">保存</div>
    </div>
    <!-- 侧边栏内容 -->
    <!--业务专长-->
    <div id="doc-oc-demo1" class="am-offcanvas">
      <div class="am-offcanvas-bar am-offcanvas-bar-flip" id="offcanvas-bar">
        <div class="am-offcanvas-content">
          <header data-am-widget="header" class="am-header header">
            <a href="javascript:;" class="arrow-left"></a>
            <h1 class="am-header-title">业务专长</h1>
          </header>
          <div class="be-container">
            <div class="word">
              <textarea name="" rows="5" cols="" class="txt" placeholder="填写您的专长，多个可用英文“/”隔开" id="Expertise" maxlength="240"></textarea>
            </div>
            <div class="submit">保存 </div>
          </div>
        </div>
      </div>
    </div>
    <!--公司简称-->
    <div id="doc-oc-demo2" class="am-offcanvas">
      <div class="am-offcanvas-bar am-offcanvas-bar-flip" id="offcanvas-bar">
        <div class="am-offcanvas-content">
          <header data-am-widget="header" class="am-header header">
            <a href="javascript:;" class="arrow-left"></a>
            <h1 class="am-header-title">公司简称</h1>
          </header>
          <div class="be-container">
            <div class="word">
              <textarea name="" rows="1" cols="" class="txt" placeholder="最多8个字" maxlength="8" id="Company_name"></textarea>
            </div>
            <div class="submit">保存 </div>
          </div>
        </div>
      </div>
    </div>
    <!--职务/职称-->
    <div id="doc-oc-demo3" class="am-offcanvas">
      <div class="am-offcanvas-bar am-offcanvas-bar-flip" id="offcanvas-bar">
        <div class="am-offcanvas-content">
          <header data-am-widget="header" class="am-header header">
            <a href="javascript:;" class="arrow-left"></a>
            <h1 class="am-header-title">职位/职称</h1>
          </header>
          <div class="be-container">
            <div class="word">
              <textarea name="" rows="1" cols="" class="txt" placeholder="请输入您的职位/职称" id="Capacity"></textarea>
            </div>
            <div class="submit">保存 </div>
          </div>
        </div>
      </div>
    </div>
    <!--微信号-->
    <div id="doc-oc-demo4" class="am-offcanvas">
      <div class="am-offcanvas-bar am-offcanvas-bar-flip" id="offcanvas-bar">
        <div class="am-offcanvas-content">
          <header data-am-widget="header" class="am-header header">
            <a href="javascript:;" class="arrow-left"></a>
            <h1 class="am-header-title">绑定微信号</h1>
          </header>
          <div class="be-container">
            <div class="word">
              <textarea name="" rows="1" cols="" class="txt" placeholder="输入您的微信号" id="Wx_number"></textarea>
            </div>
            <div class="submit">保存 </div>
          </div>
        </div>
      </div>
    </div>
  </body>
  <script type="text/javascript" src="../assets/js/jquery.min.js"></script>
  <script type="text/javascript" src="../assets/js/amazeui.min.js"></script>
  <script type="text/javascript" src="../assets/js/picker.min.js"></script>
  <script type="text/javascript" src="../assets/js/exif.min.js"></script>
  <script type="text/javascript" src="../assets/js/common.js"></script>
  <script type="text/javascript" src="../assets/js/template.js"></script>

  <script>
    	token = getCookie('token');
    //获取用户信息
    var params = {
      token: token
    };
    postAjax(reqUrl('client_get'), params, false, function(data) {
      if(data.error_code == 200) {
        window.location.href = preUrl('log/login.html?path=my/my.html');
      } else if(data.success) {
        var html = template('template', data);
        $('#my_infor').html(html);
      }else{
    	  mask(data.msg)
      }
    })

    //上传头像
    $('.upload_img').on('change', function(e) {
      if(!window.FileReader) return;
      e.stopPropagation();
      e.preventDefault();
      var file = e.target.files[0];
      var file_extension = file.name.split('.').splice(-1)[0]; //获取文件后缀
      var content = '';
      if(!file.type.match('image.*')) {
        alert('文件' + f.name + '不是图片')
        return;
      }
      var orientation;
      //EXIF js 可以读取图片的元信息 https://github.com/exif-js/exif-js
      EXIF.getData(file, function() {
        orientation = EXIF.getTag(this, 'Orientation');
      });

      var reader = new FileReader();

      reader.onload = function(e) {
        getImgData(this.result, orientation, function(base_file) {
          var params = {
            token: token,
            keytype: 1,
            file_extension: file_extension,
            title: '',
            base_file: base_file
          };
          postAjax(reqUrl('file_upload'), params, false, function(data) {
            if(data.success) {
              content = ' <img width="50" height="50" src="' + data.infor[0].imgurl + '">';
              $('.avatar').find('img').replaceWith(content);
            } else {
              mask(data.msg);
            }
          })
        });
      }
      reader.readAsDataURL(file);
    });

    //获取城市列表
    var city = [];
    postAjax(reqUrl('district_list'), '', false, function(data) {
      city = data.infor.listItems;
    })

    //获取地址
    var cityId = [];
    var nameEl = document.getElementById('addr');
    var addr = document.getElementById('address');
    var address = "";
    var first = []; /* 省，直辖市 */
    var second = []; /* 市 */
    var checked = [0, 0, 0]; /* 已选选项 */
    function creatList(obj, list) {
      obj.forEach(function(item, index, arr) {
        var temp = new Object();
        temp.text = item.name;
        temp.value = item.id;
        list.push(temp);
      })
    };
    creatList(city, first); // 省

    if(city[0].hasOwnProperty('children')) {
      creatList(city[0].children, second); //市
    } else {
      second = [{
        text: '',
        value: 0
      }];
    }

    var picker = new Picker({
      data: [first, second],
      selectedIndex: [0, 0],
      title: ''
    });

    picker.on('picker.select', function(selectedVal, selectedIndex) {
      var text1 = first[selectedIndex[0]].text;
      var text2 = second[selectedIndex[1]].text;
      addr.value = text1 + ' ' + text2;
    });

    picker.on('picker.change', function(index, selectedIndex) {
      if(index === 0) {
        firstChange();
      };

      function firstChange() {
        second = [];
        third = [];
        checked[0] = selectedIndex;
        var firstCity = city[selectedIndex];
        if(firstCity.hasOwnProperty('children')) {
          creatList(firstCity.children, second);

          var secondCity = city[selectedIndex].children[0]
        } else {
          second = [{
            text: '',
            value: 0
          }];
          checked[1] = 0;
          checked[2] = 0;
        }

        picker.refillColumn(1, second);
        picker.scrollColumn(1, 0)
      }
    });

    picker.on('picker.valuechange', function(selectedVal, selectedIndex) {
      cityId = selectedVal;
    });
//  nameEl.addEventListener('click', function() {
//    picker.show();
//  });

    //上传名片
    /* el:上传图片的元素
      keytype:上传图片类型
      El:上传图片父元素
     */

    uploadImg($('.cart_img1'), 2, $('.upload li:eq(0)')); //上传名片A面
    uploadImg($('.cart_img2'), 3, $('.upload li:eq(1)')); //上传名片B面

    function uploadImg(el, keytype, El) {
      el.on('change', function(e) {
        if(!window.FileReader) return;
        e.stopPropagation();
        e.preventDefault();
        var file = e.target.files[0];
        var file_extension = file.name.split('.').splice(-1)[0]; //获取文件后缀
        var content = '';
        if(!file.type.match('image.*')) {
          alert('文件' + f.name + '不是图片')
          return;
        }
        var orientation;
        //EXIF js 可以读取图片的元信息 https://github.com/exif-js/exif-js
        EXIF.getData(file, function() {
          orientation = EXIF.getTag(this, 'Orientation');
        });

        var reader = new FileReader();

        reader.onload = function(e) {
          getImgData(this.result, orientation, function(base_file) {
            var params = {
              token: token,
              keytype: keytype,
              file_extension: file_extension,
              title: '',
              base_file: base_file
            };
            postAjax(reqUrl('file_upload'), params, false, function(data) {
              if(data.success) {
                content = ' <img width="109" height="60" src="' + data.infor[0].imgurl + '">';
                El.find('img').replaceWith(content);
              } else {
                mask(data.msg);
              }
            })
          });
        }
        reader.readAsDataURL(file);
      });
    }

    //选中阅读状态
    $('.check').on('click', function() {
      $(this).toggleClass('active');
    });

    solveAutoClose($('#doc-oc-demo1'));
    solveAutoClose($('#doc-oc-demo2'));
    solveAutoClose($('#doc-oc-demo3'));
    solveAutoClose($('#doc-oc-demo4'));

    saveTxt($('#doc-oc-demo1'), $('#Expertise'), $('#expertise'));
    closeSideBar($('#doc-oc-demo1'));
    saveTxt($('#doc-oc-demo2'), $('#Company_name'), $('#company_name'));
    closeSideBar($('#doc-oc-demo2'));
    saveTxt($('#doc-oc-demo3'), $('#Capacity'), $('#work'));
    closeSideBar($('#doc-oc-demo3'));
    saveTxt($('#doc-oc-demo4'), $('#Wx_number'), $('#wx_name'));
    closeSideBar($('#doc-oc-demo4'));

    //解决移动设备上offcavas组件中存在键盘输入时时，也会存在自动关闭的现象。
    function solveAutoClose(el) {
      el.on('open.offcanvas.amui', function() {
        $(window).off('resize.offcanvas.amui orientationchange.offcanvas.amui');
      });
    }
    /*
     Parent:侧边栏元素
     Children:侧边栏输入框
     target:输入内容目标元素
    */
    function saveTxt(Parent, Children, target) {
      Parent.find('.submit').on('click', function() {
        Parent.offCanvas('close');
        var content = Children.val();
        target.val(content);
      });
    }

    //关闭侧边栏
    function closeSideBar(el) {
      el.find('.arrow-left').on('click', function() {
        el.offCanvas('close');
      });
    }

    //点击保存
    $('#submit').click(function() {
      var avatar_img = $('.avatar').find('img').attr('src');
      var cart_img1 = $('.upload li:eq(0)').find('img').attr('src');
      var cart_img2 = $('.upload li:eq(1)').find('img').attr('src');
      var name = $('#name').val();
      var expertise = $('#expertise').val();
      var company_name = $('#company_name').val();
      var work = $('#work').val();
      var wx_name = $('#wx_name').val();

      var params = {
        token: token,
        username: name,
        avatar: avatar_img,
        card_A: cart_img1,
        card_B: cart_img2,
        be_good: expertise,
        company: company_name,
        province: cityId[0],
        city: cityId[1],
        job: work,
        wx_name: wx_name
      }

      //保存
      postAjax(reqUrl('client_save'), params, false, function(data) {
        if(data.error_code == 200) {
          window.location.href = preUrl('log/login.html?path=my/personal-information.html');
        } else if(data.success) {
          mask('保存成功');
          window.location.href = preUrl('my/my.html');
        } else {
          mask(data.msg);
        }
      })
    })
  </script>

</html>